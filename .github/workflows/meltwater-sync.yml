name: Meltwater Data Sync

on:
  # 定时任务 (已暂停)
  # schedule:
  #   # 前5天每天运行 (UTC 1:00 = 中国时间 9:00)
  #   - cron: '0 1 * * *'
  #   # 之后每周一运行 (UTC 1:00 = 中国时间周一 9:00)
  #   # - cron: '0 1 * * 1'

  # 支持手动触发
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          playwright install --with-deps chromium

      - name: Create downloads directory
        run: mkdir -p downloads

      - name: Step 1 - Download from Meltwater
        env:
          MELTWATER_EMAIL: ${{ secrets.MELTWATER_EMAIL }}
          MELTWATER_PASSWORD: ${{ secrets.MELTWATER_PASSWORD }}
          MELTWATER_URL: "https://app.meltwater.com"
          DOWNLOAD_PATH: "./downloads"
          SEARCH_ID: "2062364"
        run: |
          echo "============================================================"
          echo "Step 1: Downloading data from Meltwater (using v2)"
          echo "============================================================"
          python3 meltwater_downloader_v2.py 2>&1 | tee download_output.txt

          # 提取下载的文件路径
          CSV_FILE=$(grep "SUCCESS:" download_output.txt | cut -d':' -f2)
          echo "CSV_FILE=$CSV_FILE" >> $GITHUB_ENV

          if [ -z "$CSV_FILE" ]; then
            echo "❌ Download failed - no CSV file found"
            exit 1
          fi

          echo "✅ Downloaded: $CSV_FILE"

      - name: Step 2 - Import to Feishu Bitable
        env:
          CSV_FILE_PATH: ${{ env.CSV_FILE }}
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          BITABLE_APP_TOKEN: ${{ secrets.BITABLE_APP_TOKEN }}
          BITABLE_TABLE_ID: ${{ secrets.BITABLE_TABLE_ID }}
        run: |
          echo "============================================================"
          echo "Step 2: Importing to Feishu Bitable"
          echo "============================================================"
          python3 meltwater_auto_import.py 2>&1 | tee import_output.txt

          # 提取导入统计信息
          IMPORT_SUCCESS=$(grep -oP '成功[:\s]+\K\d+' import_output.txt | head -1 || echo "0")
          IMPORT_FAILED=$(grep -oP '失败[:\s]+\K\d+' import_output.txt | head -1 || echo "0")
          IMPORT_TOTAL=$(grep -oP '总计[:\s]+\K\d+' import_output.txt | head -1 || echo "0")
          IMPORT_SUCCESS_RATE=$(grep -oP '成功率[:\s]+\K[\d.]+' import_output.txt | head -1 || echo "0")
          IMPORT_DUPLICATES=$(grep -oP '重复记录数[:\s]+\K\d+' import_output.txt | head -1 || echo "0")

          echo "IMPORT_SUCCESS=$IMPORT_SUCCESS" >> $GITHUB_ENV
          echo "IMPORT_FAILED=$IMPORT_FAILED" >> $GITHUB_ENV
          echo "IMPORT_TOTAL=$IMPORT_TOTAL" >> $GITHUB_ENV
          echo "IMPORT_SUCCESS_RATE=$IMPORT_SUCCESS_RATE" >> $GITHUB_ENV
          echo "IMPORT_DUPLICATES=$IMPORT_DUPLICATES" >> $GITHUB_ENV

          echo "✅ Import completed: $IMPORT_SUCCESS/$IMPORT_TOTAL successful"

      - name: Step 3 - Send Feishu Notification
        if: always()  # 即使前面步骤失败也发送通知
        env:
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          BITABLE_APP_TOKEN: ${{ secrets.BITABLE_APP_TOKEN }}
          BITABLE_TABLE_ID: ${{ secrets.BITABLE_TABLE_ID }}
          FEISHU_RECIPIENTS: ${{ secrets.FEISHU_RECIPIENTS }}
          WORKFLOW_STATUS: ${{ job.status }}
          DOWNLOAD_FILE: ${{ env.CSV_FILE }}
          DOWNLOAD_RECORDS: ${{ env.DOWNLOAD_RECORDS || 'N/A' }}
          DOWNLOAD_DURATION: ${{ env.DOWNLOAD_DURATION || 'N/A' }}
          IMPORT_SUCCESS: ${{ env.IMPORT_SUCCESS || '0' }}
          IMPORT_FAILED: ${{ env.IMPORT_FAILED || '0' }}
          IMPORT_TOTAL: ${{ env.IMPORT_TOTAL || '0' }}
          IMPORT_SUCCESS_RATE: ${{ env.IMPORT_SUCCESS_RATE || '0' }}
          IMPORT_DURATION: ${{ env.IMPORT_DURATION || 'N/A' }}
          IMPORT_DUPLICATES: ${{ env.IMPORT_DUPLICATES || '0' }}
        run: |
          echo "============================================================"
          echo "Step 3: Sending Feishu notification"
          echo "============================================================"
          python3 send_feishu_notification.py 2>&1 | tee notification_output.txt || true

          if grep -q "SUCCESS" notification_output.txt; then
            echo "✅ Notification sent successfully"
          else
            echo "⚠️ Notification failed, but workflow continues"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-outputs
          path: |
            downloads/*.csv
            downloads/*.png
            downloads/*.html
            download_output.txt
            import_output.txt
            notification_output.txt
          retention-days: 7
